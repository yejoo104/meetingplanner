{% extends "layout.html" %}

{% block title %}
{% endblock %}

{% block script %}
<script>
    document.onmouseup=SelectStop;
    var Slot = new Array();
    var Availability = new Array();
    {% for i in range(dates_days|length) %}
        {% for j in range(start_time, end_time) %}
        Slot[{{ 2 * i * (end_time - start_time) + 2 * (j - start_time) }}] = Number({{ dates_days[i][2] + j|string + "00" + j|string + "30" }});
        Availability[{{ 2 * i * (end_time - start_time) + 2 * (j - start_time) }}] = false;
        Slot[{{ 2 * i * (end_time - start_time) + 2 * (j - start_time) + 1 }}] = Number({{ dates_days[i][2] + j|string + "30" + (j + 1)|string + "00" }});
        Availability[{{ 2 * i * (end_time - start_time) + 2 * (j - start_time) + 1 }}] = false;
        {% endfor %}
    {% endfor %}
    
    var mouseDown = false;
    var toRow = -1;
    var fromRow = -1;
    var changeToAvailable=false;
    
    function SelectFrom(current){
        slot = Number(current.getAttribute("data-datetime"));
        slot_idx = Slot.indexOf(slot);
        changeToAvailable = (Availability[slot_idx] == false);
        Availability[slot_idx] = !Availability[slot_idx];
        mouseDown = true;
        
        toRow = Number(current.getAttribute("data-row"));
        fromRow = toRow;
        ChangeColor(current);
    }

    function SelectThrough(current){
        if(mouseDown){
            slot = Number(current.getAttribute("data-datetime"));
            slot_idx = Slot.indexOf(slot);
            Availability[slot_idx] = !Availability[slot_idx];
            toRow = Number(current.getAttribute("data-row"));
            ChangeColor(current);
        }
    }

    function SelectStop(){
        mouseDown = false;
    }
    
    function ChangeColor(current){
        if (changeToAvailable){
            current.style.background="#00bfff";
        }
        else{
            current.style.background="#f0ffff";
        }
    }

    function Update(){
        $.ajax({
            type: "POST",
            url: "/request",
            data: JSON.stringify(Availability),
            dataType: "json",
            contentType: "application/json",
            success: function(result){
                alert("result=" + result);
            },
            error: function(xtr, status, error){
                alert(xtr + ":" + status + ":" + error);
                alert(xtr.responseText);
            }
        });
    }
</script>
{% endblock %}

{% block main %}
<div class="container">
    <div class="row">
        <div class="column">
            <div style="width:40px; height: 24px;"></div>
            {% for i in range(start_time, end_time + 1) %}
            <div style="width: 40px; height: 30px; font-size:10px;">{{ i }}: 00</div>
            {% endfor %}
        </div>
        {% for date_day in dates_days %}
        <div class="column" style="width: 45px;">
            <div style="height: 13px; font-size: 11px; text-align: center;">
                {{ date_day[0] }}
            </div>
            <div style="height: 17px; font-size: 11px; text-align: center;">
                {{ date_day[1] }}
            </div>
            <div>
                {% for j in range(start_time, end_time) %}
                <div>
                    <div onmousedown="SelectFrom(this)" onmouseover="SelectThrough(this)" id="{{ date_day[2] }} {{ j }}00 {{ j }}30" onmouseup="SelectTo(this)" data-datetime="{{ date_day[2] }}{{ j }}00{{ j }}30" data-row="{{ 2 * (j - start_time) }}" style="width: 40px; height:15px; border-left: 1px black solid; background: #f0ffff; border-top: 1px black solid; border-right: 1px black solid;"></div>
                    {% if j != end_time - 1 %}
                    <div onmousedown="SelectFrom(this)" onmouseover="SelectThrough(this)" onmouseup="SelectTo(this)" id="{{ date_day[2] }} {{ j }}30 {{ j + 1 }}00" data-datetime="{{ date_day[2] }}{{ j }}30{{ j + 1 }}00" data-row="{{ 2 * (j - start_time) + 1 }}" style="width: 40px; height:15px; border-left: 1px black solid; background: #f0ffff; border-top: 1px black dotted; border-right: 1px black solid;"></div>
                    {% else %}
                    <div onmousedown="SelectFrom(this)" onmouseover="SelectThrough(this)" onmouseup="SelectTo(this)" id="{{ date_day[2] }} {{ j }}30 {{ j + 1 }}00" data-datetime="{{ date_day[2] }}{{ j }}30{{ j + 1 }}00" data-row="{{ 2 * (j - start_time) + 1 }}" style="width: 40px; height:15px; border-left: 1px black solid; background: #f0ffff; border-top: 1px black dotted; border-right: 1px black solid; border-bottom: 1px black solid"></div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<button type="button" class="btn btn-primary" onclick="Update()">Update Availability</button>
{% endblock %}
